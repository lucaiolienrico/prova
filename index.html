<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Piattaforma professionale per analisi investimenti immobiliari con calcolo ROI, Cashflow e Mutuo Capex-Inclusive.">
    <title>InvestPro | Suite Analisi Immobiliare</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --bg-body: #020617; --bg-card: #0f172a; --bg-input: #1e293b;
            --primary: #10b981; --primary-hover: #059669; 
            --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6;
            --text-main: #f1f5f9; --text-muted: #94a3b8;
            --border: rgba(51, 65, 85, 0.5); --radius: 12px;
        }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; min-height: 100vh; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .glass-panel { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid var(--border); }
        
        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        header { background: rgba(2, 6, 23, 0.9); border-bottom: 1px solid var(--border); padding: 1rem 2rem; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .logo { font-weight: 900; font-size: 1.5rem; letter-spacing: -0.05em; color: var(--primary); }
        .logo span { color: white; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 2rem; padding: 2rem; max-width: 1600px; margin: 0 auto; }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; position: relative; overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card:hover { border-color: var(--primary); transform: translateY(-4px); }

        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        label { font-size: 0.65rem; color: var(--text-muted); font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem; display: block; }
        input { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 0.75rem 1rem; border-radius: 10px; font-size: 0.95rem; transition: border-color 0.2s; }
        input:focus { border-color: var(--primary); outline: none; background: #020617; }

        .kpi-box { background: rgba(2, 6, 23, 0.5); border: 1px solid var(--border); border-radius: 16px; padding: 1.25rem; display: flex; justify-content: space-between; align-items: center; }
        .kpi-val { font-size: 1.5rem; font-weight: 800; color: var(--primary); font-family: 'JetBrains Mono'; }

        .btn { padding: 0.75rem 1.5rem; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; border: none; }
        .btn-primary { background: var(--primary); color: #020617; }
        .btn-primary:hover { background: var(--primary-hover); box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }

        .locked-blur { filter: blur(8px); pointer-events: none; opacity: 0.5; }
        .overlay-lock { position: absolute; inset: 0; z-index: 20; background: rgba(2, 6, 23, 0.7); backdrop-filter: blur(4px); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 2rem; }
        .is-unlocked .locked-blur { filter: none; pointer-events: auto; opacity: 1; }
        .is-unlocked .overlay-lock { display: none; }

        .amortization-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .amortization-table th { text-align: left; padding: 1rem; color: var(--text-muted); border-bottom: 2px solid var(--border); text-transform: uppercase; }
        .amortization-table td { padding: 1rem; border-bottom: 1px solid var(--border); font-family: 'JetBrains Mono'; }

        /* TOAST & LOADING */
        #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 1000; }
        .toast { background: var(--bg-card); border-left: 4px solid var(--primary); padding: 1rem 2rem; border-radius: 8px; margin-top: 1rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); transform: translateX(120%); transition: transform 0.4s; }
        .toast.show { transform: translateX(0); }
    </style>
</head>
<body>

    <header>
        <div class="flex justify-between items-center max-w-[1500px] margin-0-auto">
            <div class="logo"><i class="fa-solid fa-gem"></i> INVEST<span>PRO</span></div>
            <div class="flex items-center gap-6">
                <div id="auth-guest"><button class="btn btn-primary" onclick="app.ui.openModal('modal-login')">ACCEDI</button></div>
                <div id="auth-user" class="hidden flex items-center gap-4">
                    <span id="badge-plan" class="px-3 py-1 bg-slate-800 rounded-full text-[10px] font-black border border-slate-700">FREE</span>
                    <span id="user-email-display" class="text-xs text-slate-400"></span>
                    <button class="text-slate-500 hover:text-white" onclick="app.auth.logout()"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
        </div>
    </header>

    <div class="p-8 flex justify-between items-center max-w-[1600px] mx-auto">
        <input type="text" id="project-name" class="bg-transparent border-none text-3xl font-black text-white outline-none w-full max-w-[500px]" value="Analisi Senza Nome">
        <div class="flex gap-4">
            <button class="btn border border-slate-700 text-slate-300" onclick="app.data.openDealsList()"><i class="fa-solid fa-folder"></i> I MIEI DEAL</button>
            <button class="btn btn-primary" onclick="app.data.saveProject()"><i class="fa-solid fa-floppy-disk"></i> SALVA ANALISI</button>
        </div>
    </div>

    <main class="dashboard-grid">
        
        <div class="card">
            <div class="flex items-center gap-4 mb-8">
                <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-slate-900 font-black">A</div>
                <h2 class="text-xl font-bold uppercase tracking-tighter">Conto Economico Affitti Brevi</h2>
            </div>

            <div class="form-group mb-6">
                <label>Geolocalizzazione Immobile</label>
                <div class="relative">
                    <input type="text" id="geo-search" placeholder="Cerca città o indirizzo..." autocomplete="off">
                    <div id="geo-results" class="absolute top-full left-0 right-0 bg-slate-900 border border-slate-700 mt-2 rounded-xl hidden z-50 overflow-hidden"></div>
                </div>
            </div>

            <div class="input-grid">
                <div class="form-group"><label>ADR Medio (€)</label><input type="number" id="adr" value="120"></div>
                <div class="form-group"><label>Tassa Soggiorno (€)</label><input type="number" id="city-tax" value="4"></div>
            </div>
            <div class="input-grid">
                <div class="form-group"><label>Commissioni OTA (%)</label><input type="number" id="portal-comm" value="18"></div>
                <div class="form-group"><label>Cedolare / Tasse (%)</label><input type="number" id="tax-rate" value="21"></div>
            </div>
            <div class="input-grid">
                <div class="form-group"><label>Occupazione (%)</label><input type="number" id="occ" value="65"></div>
                <div class="form-group"><label>Costi Notte (€)</label><input type="number" id="var-costs" value="15"></div>
            </div>
            <div class="form-group mb-8"><label>Costi Fissi Mensili (€)</label><input type="number" id="fixed-costs" value="600"></div>
            
            <div class="space-y-4">
                <div class="kpi-box"><span class="text-xs font-bold text-slate-400 uppercase">MOL Mensile Lordo</span><span class="kpi-val" id="res-mol-month">-- €</span></div>
                <div class="kpi-box border-emerald-500/50 bg-emerald-500/5"><span class="text-xs font-bold text-emerald-400 uppercase">Cash Flow Gestione</span><span class="kpi-val" id="res-net-night">-- €</span></div>
            </div>

            <div class="mt-8 h-[250px]"><canvas id="profitChart"></canvas></div>
        </div>

        <div class="card" id="card-pro">
            <div class="overlay-lock">
                <i class="fa-solid fa-lock text-4xl text-primary mb-4"></i>
                <h3 class="text-xl font-bold text-white mb-2">FUNZIONALITÀ PRO</h3>
                <p class="text-slate-400 text-sm mb-6 max-w-[250px]">Sblocca la logica Capex-Inclusive, il calcolo del ROI reale e il piano di ammortamento.</p>
                <button class="btn btn-primary" onclick="app.payment.start()">SBLOCCA ORA (9,90€)</button>
            </div>

            <div class="flex items-center gap-4 mb-8">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-slate-900 font-black">B</div>
                <h2 class="text-xl font-bold uppercase tracking-tighter text-white">Finanziario & Mutuo Capex</h2>
            </div>

            <div class="locked-blur">
                <div class="form-group mb-6"><label>Prezzo Acquisto (€)</label><input type="number" id="price" value="250000"></div>
                
                <div class="input-grid">
                    <div class="form-group"><label>Ristrutturazione (€)</label><input type="number" id="reno" value="15000"></div>
                    <div class="form-group"><label>Spese Notaio/Extra (€)</label><input type="number" id="closing" value="10000"></div>
                </div>

                <div class="input-grid">
                    <div class="form-group"><label>LTV Mutuo (%)</label><input type="number" id="ltv" value="80"></div>
                    <div class="form-group"><label>Tasso (%)</label><input type="number" id="rate" value="3.5" step="0.1"></div>
                </div>
                <div class="form-group mb-8"><label>Durata (Anni)</label><input type="number" id="years" value="20"></div>

                <div class="space-y-4">
                    <div class="kpi-box"><span class="text-xs font-bold text-slate-400 uppercase">Rata Mensile</span><span class="kpi-val" id="res-mortgage">-- €</span></div>
                    <div class="kpi-box border-emerald-500 bg-emerald-500 text-slate-900">
                        <span class="text-xs font-bold uppercase">Cash Flow Netto Finale</span>
                        <span class="kpi-val !text-slate-900" id="res-cashflow">-- €</span>
                    </div>
                </div>

                <div class="mt-8 grid grid-cols-2 gap-4">
                    <div class="p-4 bg-slate-950/50 rounded-2xl border border-blue-500/30">
                        <label class="!text-blue-400">Equity (Cash In)</label>
                        <span class="text-lg font-bold font-mono" id="res-downpayment">-- €</span>
                    </div>
                    <div class="p-4 bg-slate-950/50 rounded-2xl border border-red-500/30">
                        <label class="!text-red-400">Interessi Totali</label>
                        <span class="text-lg font-bold font-mono" id="res-total-interest">-- €</span>
                    </div>
                </div>

                <button class="btn w-full justify-center mt-6 border border-slate-700" onclick="app.calc.showAmortization()">
                    <i class="fa-solid fa-list-check"></i> PIANO AMMORTAMENTO ANNUALE
                </button>
            </div>
        </div>

    </main>

    <div id="modal-login" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md hidden z-[200] items-center justify-center p-6">
        <div class="bg-slate-900 border border-slate-700 p-10 rounded-[32px] max-w-md w-full text-center">
            <h2 class="text-2xl font-black mb-8">ACCEDI A INVESTPRO</h2>
            <button class="btn btn-primary w-full justify-center py-4 mb-4" onclick="app.auth.loginGoogle()">
                <i class="fa-brands fa-google"></i> CONTINUA CON GOOGLE
            </button>
            <button class="text-slate-500 text-xs font-bold uppercase" onclick="app.ui.closeModal('modal-login')">ANNULLA</button>
        </div>
    </div>

    <div id="modal-deals" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md hidden z-[200] items-center justify-center p-6">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-[32px] max-w-2xl w-full">
            <h2 class="text-2xl font-black mb-6">I MIEI DEAL SALVATI</h2>
            <div id="deals-container" class="space-y-2 max-h-[400px] overflow-y-auto pr-2"></div>
            <button class="btn btn-primary w-full justify-center mt-8" onclick="app.ui.closeModal('modal-deals')">CHIUDI</button>
        </div>
    </div>

    <div id="modal-amortization" class="fixed inset-0 bg-slate-950/95 backdrop-blur-md hidden z-[200] items-center justify-center p-6">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-[32px] max-w-4xl w-full overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black">PIANO AMMORTAMENTO</h2>
                <button class="text-slate-500 hover:text-white" onclick="app.ui.closeModal('modal-amortization')"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="overflow-y-auto flex-1">
                <table class="amortization-table">
                    <thead><tr><th>Anno</th><th>Interessi</th><th>Capitale</th><th>Residuo</th></tr></thead>
                    <tbody id="amortization-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        // CONFIGURAZIONE FIREBASE
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyDiGDvR2yXm0DE7vlJNGrIPQB0G-ntLHc0",
                authDomain: "analisimmobiliare-3b4a7.firebaseapp.com",
                projectId: "analisimmobiliare-3b4a7",
                storageBucket: "analisimmobiliare-3b4a7.firebasestorage.app",
                messagingSenderId: "29979040948",
                appId: "1:29979040948:web:597ea331e06567d8d50be1"
            },
            stripeLink: "https://buy.stripe.com/test_4gM8wP85i5I0flc0PygjC01"
        };

        const state = { user: null, isPro: false, currentDocId: null, chartInstance: null };

        const app = {
            init: () => {
                firebase.initializeApp(CONFIG.firebase);
                app.services.auth = firebase.auth();
                app.services.db = firebase.firestore();
                
                app.auth.init();
                app.chart.init();
                app.calc.update();
                
                // Geo-search setup
                document.getElementById('geo-search').addEventListener('input', (e) => app.geo.debouncedSearch(e.target.value));
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    input.addEventListener('input', () => app.calc.update());
                });
            },

            services: { auth: null, db: null },

            ui: {
                openModal: (id) => document.getElementById(id).style.display = 'flex',
                closeModal: (id) => document.getElementById(id).style.display = 'none',
                showToast: (msg) => {
                    const t = document.createElement('div');
                    t.className = 'toast';
                    t.textContent = msg;
                    document.getElementById('toast-container').appendChild(t);
                    setTimeout(() => t.classList.add('show'), 100);
                    setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 500); }, 3000);
                },
                updateAuthUI: () => {
                    const u = state.user;
                    document.getElementById('auth-guest').classList.toggle('hidden', !!u);
                    document.getElementById('auth-user').classList.toggle('hidden', !u);
                    if(u) document.getElementById('user-email-display').textContent = u.email;
                },
                setProStatus: (active) => {
                    state.isPro = active;
                    document.getElementById('card-pro').classList.toggle('is-unlocked', active);
                    const b = document.getElementById('badge-plan');
                    b.textContent = active ? 'PRO' : 'FREE';
                    b.style.color = active ? '#10b981' : '#94a3b8';
                    b.style.borderColor = active ? '#10b981' : '#334155';
                }
            },

            calc: {
                get: (id) => parseFloat(document.getElementById(id).value) || 0,
                format: (n) => n.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' }),
                update: () => {
                    const c = app.calc;
                    
                    // --- GESTIONE OPERATIVA ---
                    const totalRev = c.get('adr') * 365 * (c.get('occ')/100);
                    const ota = totalRev * (c.get('portal-comm')/100);
                    const taxes = (totalRev - ota) * (c.get('tax-rate')/100);
                    const opCosts = (c.get('var-costs') * 365 * (c.get('occ')/100)) + (c.get('fixed-costs') * 12) + (c.get('city-tax') * 365 * (c.get('occ')/100));
                    
                    const molAnnuo = totalRev - ota - taxes - opCosts;
                    const molMese = molAnnuo / 12;

                    document.getElementById('res-mol-month').textContent = c.format(molMese);
                    document.getElementById('res-net-night').textContent = c.format(molAnnuo / (365 * c.get('occ')/100));

                    app.chart.update(ota, taxes, opCosts, molAnnuo);

                    // --- LOGICA MUTUO CAPEX-INCLUSIVE ---
                    const price = c.get('price');
                    const reno = c.get('reno');
                    const closing = c.get('closing');
                    const ltv = c.get('ltv') / 100;
                    
                    // CORREZIONE CRITICA: Base calcolata su Acquisto + Ristrutturazione
                    const loanBase = price + reno;
                    const loanAmount = loanBase * ltv;
                    
                    // Capitale Iniziale (Equity) = (Costo Totale - Mutuo)
                    const initialCapital = (loanBase + closing) - loanAmount;
                    
                    const rateAnnuo = c.get('rate') / 100;
                    const years = c.get('years');
                    
                    let monthlyPayment = 0;
                    if(rateAnnuo > 0 && years > 0) {
                        const i = rateAnnuo / 12;
                        const n = years * 12;
                        monthlyPayment = loanAmount * (i * Math.pow(1+i, n)) / (Math.pow(1+i, n) - 1);
                    } else if(years > 0) {
                        monthlyPayment = loanAmount / (years * 12);
                    }

                    const totalInterest = (monthlyPayment * years * 12) - loanAmount;

                    document.getElementById('res-mortgage').textContent = c.format(monthlyPayment);
                    document.getElementById('res-cashflow').textContent = c.format(molMese - monthlyPayment);
                    document.getElementById('res-downpayment').textContent = c.format(initialCapital);
                    document.getElementById('res-total-interest').textContent = c.format(totalInterest > 0 ? totalInterest : 0);
                },
                showAmortization: () => {
                    const c = app.calc;
                    const loanBase = c.get('price') + c.get('reno');
                    const loan = loanBase * (c.get('ltv')/100);
                    const rate = c.get('rate')/100;
                    const years = c.get('years');
                    
                    if(loan <= 0 || years <= 0) return;
                    
                    const i = rate / 12;
                    const n = years * 12;
                    const pmt = (i > 0) ? loan * (i * Math.pow(1+i, n)) / (Math.pow(1+i, n) - 1) : loan/n;
                    
                    let balance = loan;
                    let html = '';
                    for(let y = 1; y <= years; y++) {
                        let yInt = 0, yPrin = 0;
                        for(let m = 1; m <= 12; m++) {
                            let mInt = balance * i;
                            let mPrin = pmt - mInt;
                            yInt += mInt; yPrin += mPrin; balance -= mPrin;
                        }
                        html += `<tr><td>Anno ${y}</td><td>${c.format(yInt)}</td><td>${c.format(yPrin)}</td><td>${c.format(Math.max(0, balance))}</td></tr>`;
                    }
                    document.getElementById('amortization-body').innerHTML = html;
                    app.ui.openModal('modal-amortization');
                }
            },

            geo: {
                search: async (q) => {
                    if(q.length < 3) return;
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&countrycodes=it&limit=5`);
                    const data = await res.json();
                    const container = document.getElementById('geo-results');
                    container.innerHTML = '';
                    container.classList.remove('hidden');
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'p-4 border-b border-slate-800 hover:bg-slate-800 cursor-pointer text-sm';
                        div.textContent = item.display_name;
                        div.onclick = () => {
                            document.getElementById('geo-search').value = item.display_name;
                            container.classList.add('hidden');
                            app.ui.showToast("Località impostata correttamente");
                        };
                        container.appendChild(div);
                    });
                },
                debouncedSearch: (q) => {
                    clearTimeout(window.geoTimer);
                    window.geoTimer = setTimeout(() => app.geo.search(q), 500);
                }
            },

            chart: {
                init: () => {
                    const ctx = document.getElementById('profitChart').getContext('2d');
                    state.chartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['OTA', 'Tasse', 'Costi', 'Utile'],
                            datasets: [{
                                data: [0, 0, 0, 0],
                                backgroundColor: ['#f59e0b', '#ef4444', '#3b82f6', '#10b981'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            cutout: '80%',
                            plugins: { legend: { display: false } },
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                },
                update: (ota, tax, costs, net) => {
                    if(!state.chartInstance) return;
                    state.chartInstance.data.datasets[0].data = [ota, tax, costs, Math.max(0, net)];
                    state.chartInstance.update();
                }
            },

            auth: {
                init: () => {
                    app.services.auth.onAuthStateChanged(async (u) => {
                        state.user = u;
                        app.ui.updateAuthUI();
                        if(u) {
                            const d = await app.services.db.collection('users').doc(u.uid).get();
                            if(d.exists) app.ui.setProStatus(d.data().plan === 'pro');
                            else await app.services.db.collection('users').doc(u.uid).set({ email: u.email, plan: 'free' });
                        } else {
                            app.ui.setProStatus(false);
                        }
                    });
                },
                loginGoogle: () => app.services.auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()),
                logout: () => app.services.auth.signOut().then(() => location.reload())
            },

            data: {
                saveProject: async () => {
                    if(!state.user) return app.ui.openModal('modal-login');
                    const inputs = {};
                    document.querySelectorAll('input').forEach(i => inputs[i.id] = i.value);
                    const payload = {
                        uid: state.user.uid,
                        name: document.getElementById('project-name').value,
                        inputs,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    if(state.currentDocId) await app.services.db.collection('projects').doc(state.currentDocId).update(payload);
                    else state.currentDocId = (await app.services.db.collection('projects').add(payload)).id;
                    app.ui.showToast("Analisi salvata correttamente");
                },
                openDealsList: async () => {
                    if(!state.user) return app.ui.openModal('modal-login');
                    const snap = await app.services.db.collection('projects').where('uid', '==', state.user.uid).get();
                    const container = document.getElementById('deals-container');
                    container.innerHTML = '';
                    snap.forEach(doc => {
                        const d = doc.data();
                        const div = document.createElement('div');
                        div.className = 'p-4 bg-slate-800/50 rounded-xl hover:border-emerald-500 border border-transparent cursor-pointer flex justify-between items-center';
                        div.innerHTML = `<div><div class="font-bold text-white">${d.name}</div><div class="text-[10px] text-slate-500 uppercase">${doc.id}</div></div><i class="fa-solid fa-chevron-right text-slate-600"></i>`;
                        div.onclick = () => {
                            state.currentDocId = doc.id;
                            document.getElementById('project-name').value = d.name;
                            Object.keys(d.inputs).forEach(k => {
                                const el = document.getElementById(k);
                                if(el) el.value = d.inputs[k];
                            });
                            app.calc.update();
                            app.ui.closeModal('modal-deals');
                        };
                        container.appendChild(div);
                    });
                    app.ui.openModal('modal-deals');
                }
            },

            payment: {
                start: () => {
                    if(!state.user) return app.ui.openModal('modal-login');
                    window.open(`${CONFIG.stripeLink}?prefilled_email=${state.user.email}&client_reference_id=${state.user.uid}`, '_blank');
                    // Polling per aggiornamento stato pro (semplificato)
                    const poll = setInterval(async () => {
                        const d = await app.services.db.collection('users').doc(state.user.uid).get();
                        if(d.data().plan === 'pro') {
                            app.ui.setProStatus(true);
                            clearInterval(poll);
                        }
                    }, 5000);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>