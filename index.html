<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="InvestPro | Suite professionale per l'analisi degli investimenti immobiliari e locazioni brevi.">
    <title>InvestPro | Analisi Professionale Immobiliare</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

    <style>
        :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-input: #020617;
            --primary: #10b981; --primary-hover: #059669; 
            --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6;
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --border: #334155; --radius: 10px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            --font-main: 'Inter', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: var(--font-main); min-height: 100vh; display: flex; flex-direction: column; line-height: 1.6; }

        header { background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid var(--border); padding: 1rem 2rem; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 800; font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 0.6rem; }
        .logo span { color: white; }

        .btn { padding: 0.7rem 1.4rem; border-radius: var(--radius); cursor: pointer; font-weight: 600; font-size: 0.85rem; border: 1px solid var(--border); background: var(--bg-card); color: white; display: inline-flex; align-items: center; gap: 0.6rem; transition: all 0.2s ease; text-decoration: none; }
        .btn:hover { background: var(--border); transform: translateY(-2px); }
        .btn-primary { background: var(--primary); border-color: var(--primary); color: #000; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-admin { position: fixed; bottom: 25px; left: 25px; z-index: 100; background: var(--warning); color: #000; font-weight: 800; }

        .toolbar { max-width: 1400px; margin: 2rem auto 0; padding: 0 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1.5rem; }
        .project-input { background: transparent; border: none; border-bottom: 2px solid var(--border); color: white; font-size: 1.6rem; font-weight: 700; width: 100%; max-width: 450px; padding: 0.5rem 0; }
        .project-input:focus { border-color: var(--primary); }

        main { padding: 2rem 1.5rem; max-width: 1400px; margin: 0 auto; width: 100%; flex: 1; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap: 2rem; }

        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 1.8rem; position: relative; display: flex; flex-direction: column; box-shadow: var(--shadow); }
        .card-header { margin-bottom: 1.8rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 14px; }
        .step-circle { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: black; font-weight: 800; display: flex; align-items: center; justify-content: center; }

        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.6rem; }
        label { font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; }
        input { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 0.9rem; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s; }
        input:focus { border-color: var(--primary); }

        .kpi-container { background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: 10px; padding: 1.2rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .kpi-title { font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; }
        .kpi-value { font-size: 1.3rem; font-weight: 700; color: var(--primary); font-variant-numeric: tabular-nums; }
        .chart-wrapper { margin-top: 1.5rem; height: 280px; width: 100%; }

        .dropdown-menu { position: absolute; top: 100%; left: 0; width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: 0 0 10px 10px; z-index: 60; max-height: 250px; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .dropdown-item { padding: 1rem; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 0.9rem; color: var(--text-muted); }
        .dropdown-item:hover { background: var(--primary); color: black; font-weight: 600; }

        .locked-blur { filter: blur(6px); pointer-events: none; opacity: 0.3; }
        .overlay-lock { position: absolute; inset: 0; z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; text-align: center; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(4px); border-radius: 16px; }
        .is-unlocked .locked-blur { filter: none; pointer-events: auto; opacity: 1; }
        .is-unlocked .overlay-lock { display: none; }

        .hidden { display: none !important; }
        .badge { padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.7rem; font-weight: 800; background: var(--border); color: var(--text-muted); }
        .badge.pro { background: var(--primary); color: black; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }

        #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 9999; display: flex; flex-direction: column; gap: 12px; }
        .toast { background: var(--bg-card); border-left: 5px solid var(--primary); color: white; padding: 1.2rem; border-radius: 8px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 1rem; min-width: 300px; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .toast.show { transform: translateX(0); }

        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-backdrop.active { opacity: 1; pointer-events: auto; }
        .modal-panel { background: var(--bg-card); border: 1px solid var(--border); width: 95%; max-width: 700px; border-radius: 20px; padding: 2.5rem; max-height: 90vh; overflow-y: auto; }

        .amortization-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .amortization-table th { text-align: right; padding: 1rem; border-bottom: 2px solid var(--border); color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; }
        .amortization-table th:first-child { text-align: left; }
        .amortization-table td { text-align: right; padding: 1rem; border-bottom: 1px solid var(--border); font-variant-numeric: tabular-nums; }
        .amortization-table td:first-child { text-align: left; color: var(--primary); font-weight: 700; }

        @media(max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } .toolbar { flex-direction: column; align-items: flex-start; } }
    </style>
</head>
<body>

    <div id="loading-overlay" class="modal-backdrop" style="z-index: 10001; flex-direction: column;">
        <div style="width: 50px; height: 50px; border: 5px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 1rem; font-weight: 600;">Analisi in corso...</p>
    </div>
    <div id="toast-container"></div>

    <header>
        <div class="nav-container">
            <div class="logo"><i class="fa-solid fa-chart-line"></i> <span>InvestPro</span></div>
            <div id="auth-section">
                <div id="auth-guest"><button class="btn btn-primary" onclick="app.ui.openModal('modal-login')">Inizia Ora</button></div>
                <div id="auth-user" class="hidden">
                    <span id="badge-plan" class="badge">FREE</span>
                    <span id="user-email-display" style="font-size: 0.85rem; margin: 0 15px; font-weight: 500;"></span>
                    <button class="btn" onclick="app.auth.logout()"><i class="fa-solid fa-sign-out-alt"></i></button>
                </div>
            </div>
        </div>
    </header>

    <section class="toolbar">
        <input type="text" id="project-name" class="project-input" value="Nuova Analisi..." placeholder="Nome Progetto">
        <div style="display: flex; gap: 1rem;">
            <button class="btn" onclick="app.data.openDealsList()"><i class="fa-solid fa-layer-group"></i> I Miei Deal</button>
            <button class="btn btn-primary" onclick="app.data.saveProject()"><i class="fa-solid fa-save"></i> Salva</button>
        </div>
    </section>

    <main>
        <div class="dashboard-grid">
            
            <div class="card">
                <div class="card-header"><div class="step-circle">A</div><h3>Conto Economico (Locazione)</h3></div>
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label>Località Immobile</label>
                    <div style="position: relative;">
                        <input type="text" id="geo-search" placeholder="Cerca città (es. Milano, Roma...)" autocomplete="off">
                        <i class="fa-solid fa-location-dot" style="position: absolute; right: 15px; top: 15px; color: var(--text-muted);"></i>
                    </div>
                    <div id="geo-results" class="dropdown-menu hidden"></div>
                </div>

                <div class="input-grid">
                    <div class="form-group"><label>ADR (€/Notte)</label><input type="number" id="adr" value="150"></div>
                    <div class="form-group"><label>Occupazione (%)</label><input type="number" id="occ" value="70"></div>
                </div>
                <div class="input-grid">
                    <div class="form-group"><label>Comm. Portali (%)</label><input type="number" id="portal-comm" value="18"></div>
                    <div class="form-group"><label>Cedolare Secca (%)</label><input type="number" id="tax-rate" value="21"></div>
                </div>
                <div class="input-grid">
                    <div class="form-group"><label>Costi Var./Notte (€)</label><input type="number" id="var-costs" value="20"></div>
                    <div class="form-group"><label>Tassa Soggiorno (€)</label><input type="number" id="city-tax" value="4.5"></div>
                </div>
                <div class="form-group" style="margin-bottom: 2rem;"><label>Costi Fissi Mensili (€)</label><input type="number" id="fixed-costs" value="700"></div>
                
                <div class="kpi-container"><span class="kpi-title">Fatturato Lordo Annuo</span><span class="kpi-value" id="res-gross-year" style="color: white;">-- €</span></div>
                <div class="kpi-container" style="border-color: var(--primary); background: rgba(16, 185, 129, 0.1);"><span class="kpi-title" style="color: var(--primary);">Utile Netto Mensile</span><span class="kpi-value" id="res-mol-month">-- €</span></div>

                <div class="chart-wrapper"><canvas id="profitChart"></canvas></div>
            </div>

            <div class="card" id="card-pro">
                <div class="overlay-lock">
                    <i class="fa-solid fa-crown" style="font-size: 3.5rem; color: var(--warning); margin-bottom: 1.5rem;"></i>
                    <h3 style="margin-bottom: 0.5rem;">Suite Analisi Avanzata</h3>
                    <p style="color: var(--text-muted); margin-bottom: 2rem; max-width: 300px;">Sblocca il calcolo del Mutuo, ROI, ROE e Piano di Ammortamento professionale.</p>
                    <button class="btn btn-primary" onclick="app.payment.start()">Sblocca Versione PRO (9,90€)</button>
                </div>
                
                <div class="card-header"><div class="step-circle" style="background: white; color: black;">B</div><h3>Finanza & Investimento</h3></div>
                
                <div class="locked-blur">
                    <div class="form-group" style="margin-bottom: 1.5rem;"><label>Prezzo Acquisto (€)</label><input type="number" id="price" value="300000"></div>
                    <div class="input-grid">
                        <div class="form-group"><label>Ristrutturazione (€)</label><input type="number" id="reno" value="20000"></div>
                        <div class="form-group"><label>Costi Acquisto* (€)</label><input type="number" id="closing" value="12000"></div>
                    </div>
                    <div class="input-grid">
                        <div class="form-group"><label>LTV Mutuo (%)</label><input type="number" id="ltv" value="80"></div>
                        <div class="form-group"><label>Tasso Interesse (%)</label><input type="number" id="rate" value="3.8" step="0.1"></div>
                    </div>
                    <div class="form-group" style="margin-bottom: 2rem;"><label>Durata Mutuo (Anni)</label><input type="number" id="years" value="25"></div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="kpi-container" style="flex-direction: column; align-items: flex-start; gap: 0.5rem;">
                            <span class="kpi-title">ROI (Operazione)</span>
                            <span class="kpi-value" id="res-roi" style="color: var(--info);">-- %</span>
                        </div>
                        <div class="kpi-container" style="flex-direction: column; align-items: flex-start; gap: 0.5rem;">
                            <span class="kpi-title">ROE (Sull'Equity)</span>
                            <span class="kpi-value" id="res-roe" style="color: var(--warning);">-- %</span>
                        </div>
                    </div>

                    <div class="kpi-container" style="background: var(--primary); border: none;"><span class="kpi-title" style="color: black;">Cash Flow Netto Mensile</span><span class="kpi-value" id="res-cashflow" style="color: black;">-- €</span></div>

                    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                            <span style="color: var(--text-muted);">Capitale Iniziale (Cash Out):</span>
                            <span id="res-downpayment" style="font-weight: 700;">-- €</span>
                        </div>
                        <button class="btn" style="width: 100%; justify-content: center;" onclick="app.calc.showAmortization()">
                            <i class="fa-solid fa-list-check"></i> Vedi Piano Ammortamento
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-login" class="modal-backdrop">
        <div class="modal-panel" style="text-align: center; max-width: 400px;">
            <i class="fa-solid fa-user-circle" style="font-size: 4rem; color: var(--primary); margin-bottom: 1.5rem;"></i>
            <h2 style="margin-bottom: 1rem;">Accedi a InvestPro</h2>
            <p style="color: var(--text-muted); margin-bottom: 2rem;">Salva i tuoi deal e accedi alle analisi avanzate da qualsiasi dispositivo.</p>
            <button class="btn btn-primary" style="width: 100%; justify-content: center; padding: 1rem;" onclick="app.auth.loginGoogle()">
                <i class="fa-brands fa-google"></i> Continua con Google
            </button>
            <button class="btn" style="width: 100%; margin-top: 1rem; justify-content: center;" onclick="app.ui.closeModal('modal-login')">Annulla</button>
        </div>
    </div>

    <div id="modal-amortization" class="modal-backdrop">
        <div class="modal-panel" style="max-width: 850px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:2rem; align-items:center;">
                <h2>Ammortamento Francese (Dettaglio Annuale)</h2>
                <button class="btn" onclick="app.ui.closeModal('modal-amortization')"><i class="fa-solid fa-times"></i></button>
            </div>
            <div style="max-height: 65vh; overflow-y: auto;">
                <table class="amortization-table">
                    <thead>
                        <tr><th>Anno</th><th>Quota Interessi</th><th>Quota Capitale</th><th>Debito Residuo</th></tr>
                    </thead>
                    <tbody id="amortization-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <button id="admin-trigger" class="btn btn-admin hidden" onclick="app.ui.openModal('modal-admin')">PANNELLO ADMIN</button>

    <script>
        // --- 1. CONFIGURAZIONE ---
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyDiGDvR2yXm0DE7vlJNGrIPQB0G-ntLHc0",
                authDomain: "analisimmobiliare-3b4a7.firebaseapp.com",
                projectId: "analisimmobiliare-3b4a7",
                storageBucket: "analisimmobiliare-3b4a7.firebasestorage.app",
                messagingSenderId: "29979040948",
                appId: "1:29979040948:web:597ea331e06567d8d50be1"
            },
            adminEmail: "lucaiolienrico1@gmail.com",
            stripeLink: "https://buy.stripe.com/test_4gM8wP85i5I0flc0PygjC01"
        };

        const state = { user: null, isPro: false, currentDocId: null, chart: null };

        // --- 2. CORE ENGINE ---
        const app = {
            init: () => {
                firebase.initializeApp(CONFIG.firebase);
                app.services.auth = firebase.auth();
                app.services.db = firebase.firestore();
                
                app.auth.init();
                app.chart.init(); 
                app.calc.update();
                
                // Binding eventi
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    input.addEventListener('input', app.utils.debounce(() => app.calc.update(), 400));
                });

                const geoInput = document.getElementById('geo-search');
                geoInput.addEventListener('input', app.utils.debounce((e) => app.geo.search(e.target.value), 600));
            },

            services: { auth: null, db: null },

            utils: {
                debounce: (fn, wait) => {
                    let timeout;
                    return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => fn(...args), wait); };
                },
                formatEuro: (n) => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(n),
                formatPerc: (n) => n.toFixed(2) + '%'
            },

            ui: {
                setLoading: (s) => document.getElementById('loading-overlay').classList.toggle('active', s),
                openModal: (id) => document.getElementById(id).classList.add('active'),
                closeModal: (id) => document.getElementById(id).classList.remove('active'),
                showToast: (msg) => {
                    const t = document.createElement('div');
                    t.className = 'toast';
                    t.innerHTML = `<i class="fa-solid fa-info-circle"></i> <span>${msg}</span>`;
                    document.getElementById('toast-container').appendChild(t);
                    setTimeout(() => t.classList.add('show'), 10);
                    setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3500);
                },
                setProStatus: (active) => {
                    state.isPro = active;
                    document.getElementById('badge-plan').textContent = active ? "PRO" : "FREE";
                    document.getElementById('badge-plan').classList.toggle('pro', active);
                    document.getElementById('card-pro').classList.toggle('is-unlocked', active);
                }
            },

            calc: {
                val: (id) => parseFloat(document.getElementById(id).value) || 0,
                update: () => {
                    const u = app.utils;
                    const c = app.calc;

                    // A. ANALISI OPERATIVA (CORRETTA FISCALMENTE)
                    const nights = 365 * (c.val('occ')/100);
                    const grossRevenue = c.val('adr') * nights;
                    
                    // In Italia, la Cedolare Secca si calcola sul LORDO (comprese commissioni OTA se incassate dall'host)
                    const taxes = grossRevenue * (c.val('tax-rate')/100);
                    const otaFees = grossRevenue * (c.val('portal-comm')/100);
                    
                    // Costi variabili (Pulizie, Kit, etc) + Costi Fissi (Utenze, Condominio, etc)
                    const variableCosts = c.val('var-costs') * nights;
                    const fixedCostsYearly = c.val('fixed-costs') * 12;
                    
                    const totalCosts = otaFees + variableCosts + fixedCostsYearly;
                    const netProfitYearly = grossRevenue - taxes - totalCosts;

                    document.getElementById('res-gross-year').textContent = u.formatEuro(grossRevenue);
                    document.getElementById('res-mol-month').textContent = u.formatEuro(netProfitYearly / 12);

                    // B. ANALISI FINANZIARIA (ROI/ROE/MUTUO)
                    const totalInvestment = c.val('price') + c.val('reno') + c.val('closing');
                    const loanAmount = c.val('price') * (c.val('ltv')/100);
                    const equity = totalInvestment - loanAmount;

                    // Ammortamento Francese
                    const i = (c.val('rate')/100) / 12;
                    const n = c.val('years') * 12;
                    const monthlyMortgage = i > 0 ? (loanAmount * i * Math.pow(1+i, n)) / (Math.pow(1+i, n) - 1) : loanAmount / n;

                    const annualMortgage = monthlyMortgage * 12;
                    const cashFlowYearly = netProfitYearly - annualMortgage;

                    // Metriche Professionali
                    const roi = (netProfitYearly / totalInvestment) * 100;
                    const roe = (cashFlowYearly / equity) * 100;

                    document.getElementById('res-roi').textContent = u.formatPerc(roi);
                    document.getElementById('res-roe').textContent = u.formatPerc(roe);
                    document.getElementById('res-cashflow').textContent = u.formatEuro(cashFlowYearly / 12);
                    document.getElementById('res-downpayment').textContent = u.formatEuro(equity);

                    app.chart.update(netProfitYearly, otaFees, taxes, variableCosts + fixedCostsYearly);
                },

                showAmortization: () => {
                    const c = app.calc;
                    const loan = c.val('price') * (c.val('ltv')/100);
                    const annualRate = c.val('rate')/100;
                    const months = c.val('years') * 12;
                    const i = annualRate / 12;
                    const pmt = i > 0 ? (loan * i * Math.pow(1+i, months)) / (Math.pow(1+i, months) - 1) : loan / months;

                    let balance = loan;
                    let html = '';
                    for (let y = 1; y <= c.val('years'); y++) {
                        let yInt = 0, yCap = 0;
                        for (let m = 1; m <= 12; m++) {
                            let mInt = balance * i;
                            let mCap = pmt - mInt;
                            yInt += mInt; yCap += mCap; balance -= mCap;
                        }
                        html += `<tr><td>Anno ${y}</td><td>${app.utils.formatEuro(yInt)}</td><td>${app.utils.formatEuro(yCap)}</td><td>${app.utils.formatEuro(Math.max(0, balance))}</td></tr>`;
                    }
                    document.getElementById('amortization-body').innerHTML = html;
                    app.ui.openModal('modal-amortization');
                }
            },

            geo: {
                search: async (q) => {
                    if (q.length < 3) return;
                    const list = document.getElementById('geo-results');
                    list.innerHTML = '<div style="padding:1rem; font-size:0.8rem;">Ricerca...</div>';
                    list.classList.remove('hidden');

                    try {
                        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&countrycodes=it&limit=5`);
                        const d = await r.json();
                        list.innerHTML = '';
                        d.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'dropdown-item';
                            div.textContent = item.display_name.split(',')[0] + ' (' + item.display_name.split(',')[1] + ')';
                            div.onclick = () => {
                                document.getElementById('geo-search').value = div.textContent;
                                list.classList.add('hidden');
                                app.ui.showToast("Località impostata. Verifica la tassa di soggiorno locale.");
                            };
                            list.appendChild(div);
                        });
                    } catch (e) { list.classList.add('hidden'); }
                }
            },

            chart: {
                init: () => {
                    const ctx = document.getElementById('profitChart').getContext('2d');
                    state.chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Utile Netto', 'OTA', 'Tasse', 'Costi Gestione'],
                            datasets: [{ data: [0,0,0,0], backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6'], borderWidth: 0 }]
                        },
                        options: { maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', padding: 20 } } } }
                    });
                },
                update: (net, ota, tax, costs) => {
                    if (!state.chart) return;
                    state.chart.data.datasets[0].data = [Math.max(0, net), ota, tax, costs];
                    state.chart.update();
                }
            },

            auth: {
                init: () => {
                    app.services.auth.onAuthStateChanged(async (u) => {
                        state.user = u;
                        document.getElementById('auth-guest').classList.toggle('hidden', !!u);
                        document.getElementById('auth-user').classList.toggle('hidden', !u);
                        if (u) {
                            document.getElementById('user-email-display').textContent = u.email;
                            const doc = await app.services.db.collection('users').doc(u.uid).get();
                            if (doc.exists) app.ui.setProStatus(doc.data().plan === 'pro');
                            else await app.services.db.collection('users').doc(u.uid).set({ email: u.email, plan: 'free', joined: new Date() });
                            document.getElementById('admin-trigger').classList.toggle('hidden', u.email !== CONFIG.adminEmail);
                        }
                    });
                },
                loginGoogle: () => app.services.auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()),
                logout: () => app.services.auth.signOut().then(() => location.reload())
            },

            data: {
                saveProject: async () => {
                    if (!state.user) return app.ui.openModal('modal-login');
                    app.ui.setLoading(true);
                    try {
                        const inputs = {};
                        document.querySelectorAll('input').forEach(i => inputs[i.id] = i.value);
                        const payload = { uid: state.user.uid, name: document.getElementById('project-name').value, updatedAt: new Date(), inputs };
                        if (state.currentDocId) await app.services.db.collection('projects').doc(state.currentDocId).update(payload);
                        else state.currentDocId = (await app.services.db.collection('projects').add(payload)).id;
                        app.ui.showToast("Analisi salvata con successo!");
                    } catch (e) { console.error(e); }
                    app.ui.setLoading(false);
                }
            },

            payment: {
                start: () => {
                    if (!state.user) return app.ui.openModal('modal-login');
                    const link = `${CONFIG.stripeLink}?prefilled_email=${encodeURIComponent(state.user.email)}&client_reference_id=${state.user.uid}`;
                    window.open(link, '_blank');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
