<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="InvestPro Suite | Analisi professionale investimenti immobiliari e locazioni brevi 2025">
    <title>InvestPro | Suite Analisi Immobiliare</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-input: #020617;
            --primary: #10b981; --primary-hover: #059669; 
            --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6;
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --border: #334155; --radius: 12px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; min-height: 100vh; display: flex; flex-direction: column; line-height: 1.6; overflow-x: hidden; }

        header { background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid var(--border); padding: 1.2rem 2rem; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 800; font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 0.6rem; letter-spacing: -0.04em; }
        .logo span { color: white; }

        .toolbar { max-width: 1400px; margin: 2rem auto 0; padding: 0 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .project-input { background: transparent; border: none; border-bottom: 2px solid var(--border); color: white; font-size: 1.6rem; font-weight: 700; width: 100%; max-width: 450px; padding: 0.5rem 0; transition: border-color 0.3s; }
        .project-input:focus { border-color: var(--primary); }

        .btn { padding: 0.7rem 1.4rem; border-radius: var(--radius); cursor: pointer; font-weight: 600; font-size: 0.9rem; border: 1px solid var(--border); background: var(--bg-card); color: white; display: inline-flex; align-items: center; gap: 0.6rem; transition: all 0.25s; }
        .btn:hover { background: var(--border); transform: translateY(-2px); }
        .btn-primary { background: var(--primary); border-color: var(--primary); color: #000; }
        .btn-primary:hover { background: var(--primary-hover); }

        main { padding: 2rem 1.5rem; max-width: 1400px; margin: 0 auto; width: 100%; flex: 1; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap: 2.5rem; }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; position: relative; box-shadow: var(--shadow); }
        .card-header { margin-bottom: 1.8rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; }
        .step-circle { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: black; font-weight: 800; display: flex; align-items: center; justify-content: center; }

        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        label { font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; }
        input { background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 0.9rem; border-radius: 8px; font-size: 1rem; transition: all 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }

        .kpi-container { background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border); border-radius: 10px; padding: 1.2rem; margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .kpi-title { font-size: 0.8rem; color: var(--text-muted); font-weight: 700; }
        .kpi-value { font-size: 1.4rem; font-weight: 800; color: var(--primary); font-variant-numeric: tabular-nums; }

        /* GEO SEARCH */
        #geo-results { position: absolute; top: 100%; left: 0; width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: 0 0 10px 10px; z-index: 150; max-height: 250px; overflow-y: auto; box-shadow: var(--shadow); }
        .dropdown-item { padding: 1rem; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .dropdown-item:hover { background: var(--primary); color: black; font-weight: 600; }

        /* PRO LOCK */
        .locked-blur { filter: blur(6px); pointer-events: none; opacity: 0.3; transition: all 0.4s; }
        .overlay-lock { position: absolute; inset: 0; z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2.5rem; text-align: center; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(4px); border-radius: 14px; }
        .is-unlocked .locked-blur { filter: none; pointer-events: auto; opacity: 1; }
        .is-unlocked .overlay-lock { display: none; }

        /* ADMIN PANEL UI */
        #admin-panel { margin-top: 5rem; padding-top: 3rem; border-top: 2px solid var(--primary); display: none; }
        .admin-nav { display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
        .admin-tab-btn { background: transparent; border: none; color: var(--text-muted); font-weight: 700; cursor: pointer; padding: 0.5rem 1rem; font-size: 0.9rem; border-bottom: 2px solid transparent; }
        .admin-tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .admin-table-container { background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; overflow-x: auto; margin-top: 1rem; }
        .admin-table { width: 100%; border-collapse: collapse; text-align: left; min-width: 800px; }
        .admin-table th { padding: 1.2rem; background: rgba(255,255,255,0.03); color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; }
        .admin-table td { padding: 1.2rem; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .status-pill { padding: 0.3rem 0.7rem; border-radius: 20px; font-size: 0.7rem; font-weight: 800; }
        .status-success { background: rgba(16, 185, 129, 0.15); color: var(--primary); border: 1px solid var(--primary); }
        .status-pending { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid var(--warning); }

        /* MODALS */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-backdrop.active { display: flex; }
        .modal-panel { background: var(--bg-card); border: 1px solid var(--border); width: 95%; max-width: 650px; border-radius: 20px; padding: 2.5rem; position: relative; }

        /* TOAST & LOADER */
        #loading-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.95); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #loading-overlay.active { display: flex; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loading-overlay"><p style="font-weight:700; color:var(--primary);">ELABORAZIONE DATI...</p></div>
    <div id="toast-container" style="position: fixed; bottom: 30px; right: 30px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;"></div>

    <header>
        <div class="nav-container">
            <div class="logo"><i class="fa-solid fa-chart-line"></i> <span>InvestPro</span> Suite</div>
            <div class="user-menu">
                <div id="auth-guest"><button class="btn btn-primary" onclick="app.ui.openModal('modal-login')">ACCEDI / REGISTRATI</button></div>
                <div id="auth-user" class="hidden" style="display: flex; align-items: center;">
                    <span id="badge-plan" style="padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.7rem; font-weight: 800; background: var(--border);">FREE</span>
                    <span id="user-email-display" style="font-size: 0.9rem; margin: 0 15px; font-weight: 500;"></span>
                    <button class="btn" onclick="app.auth.logout()"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
        </div>
    </header>

    <section class="toolbar">
        <input type="text" id="project-name" class="project-input" value="Nuova Analisi Immobiliare">
        <div style="display: flex; gap: 1rem;">
            <button class="btn" onclick="app.report.generate()"><i class="fa-solid fa-file-pdf"></i> REPORT PDF</button>
            <button class="btn" onclick="app.data.openDealsList()"><i class="fa-solid fa-cloud"></i> I MIEI DEAL</button>
            <button class="btn btn-primary" onclick="app.data.saveProject()"><i class="fa-solid fa-floppy-disk"></i> SALVA</button>
        </div>
    </section>

    <main>
        <div class="dashboard-grid">
            
            <div class="card">
                <div class="card-header"><div class="step-circle">A</div><h3>Conto Economico (MOL)</h3></div>
                
                <div class="form-group" style="margin-bottom: 1.8rem; position: relative;">
                    <label>Località dell'Immobile</label>
                    <input type="text" id="geo-search" placeholder="Cerca comune (es. Roma, Milano)...">
                    <div id="geo-results" class="hidden"></div>
                </div>

                <div class="input-grid">
                    <div class="form-group"><label>ADR (Prezzo Notte €)</label><input type="number" id="adr" value="135"></div>
                    <div class="form-group"><label>Occupazione (%)</label><input type="number" id="occ" value="70"></div>
                </div>
                <div class="input-grid">
                    <div class="form-group"><label>Comm. Portali (%)</label><input type="number" id="portal-comm" value="18"></div>
                    <div class="form-group"><label>Cedolare Secca (%)</label><input type="number" id="tax-rate" value="21"></div>
                </div>
                <div class="input-grid">
                    <div class="form-group"><label>Costi Variabili (€)</label><input type="number" id="var-costs" value="20"></div>
                    <div class="form-group"><label>Costi Fissi Mensili (€)</label><input type="number" id="fixed-costs" value="550"></div>
                </div>
                
                <div class="kpi-container" style="border-color: var(--primary); background: rgba(16, 185, 129, 0.05);">
                    <span class="kpi-title">MOL Mensile (Margine Op. Lordo)</span>
                    <span class="kpi-value" id="res-mol-month">-- €</span>
                </div>

                <div style="height: 250px; margin-top: 2rem;"><canvas id="profitChart"></canvas></div>
            </div>

            <div class="card" id="card-pro">
                <div class="overlay-lock">
                    <i class="fa-solid fa-crown" style="font-size: 3rem; color: var(--warning); margin-bottom: 1.5rem;"></i>
                    <h3>InvestPro Analysis</h3>
                    <p style="color: var(--text-muted); margin-bottom: 2rem; max-width: 300px;">Sblocca il calcolo della leva finanziaria, ammortamento e ROI avanzato.</p>
                    <button class="btn btn-primary" onclick="app.payment.start()">ATTIVA ORA (9,90€)</button>
                </div>
                
                <div class="card-header"><div class="step-circle" style="background:white;">B</div><h3>Struttura Finanziaria</h3></div>
                
                <div class="locked-blur">
                    <div class="form-group" style="margin-bottom: 1.5rem;"><label>Prezzo Acquisto (€)</label><input type="number" id="price" value="280000"></div>
                    <div class="input-grid">
                        <div class="form-group"><label>LTV Mutuo (%)</label><input type="number" id="ltv" value="80"></div>
                        <div class="form-group"><label>Tasso Mutuo (%)</label><input type="number" id="rate" value="3.8" step="0.1"></div>
                    </div>
                    <div class="form-group" style="margin-bottom: 2rem;"><label>Durata (Anni)</label><input type="number" id="years" value="25"></div>
                    
                    <div class="kpi-container"><span class="kpi-title">Rata Mensile Stimata</span><span class="kpi-value" id="res-mortgage">-- €</span></div>
                    <div class="kpi-container" style="background: var(--primary); border: none;"><span class="kpi-title" style="color: black;">Cash Flow Netto Finale</span><span class="kpi-value" id="res-cashflow" style="color: black;">-- €</span></div>
                    
                    <button class="btn" style="width: 100%; justify-content: center; margin-top: 1.5rem;" onclick="app.calc.showAmortization()">
                        <i class="fa-solid fa-table-list"></i> VEDI PIANO AMMORTAMENTO
                    </button>
                </div>
            </div>
        </div>

        <section id="admin-panel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem;">
                <div>
                    <h2 style="font-weight: 800; letter-spacing: -0.03em;"><i class="fa-solid fa-shield-halved"></i> PANNELLO AMMINISTRATORE</h2>
                    <p style="color: var(--text-muted);">Controllo utenti, conversioni e stato pagamenti Stripe.</p>
                </div>
                <button class="btn btn-primary" onclick="app.admin.refresh()"><i class="fa-solid fa-rotate"></i> AGGIORNA DATI</button>
            </div>

            <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
                <div class="kpi-container" style="flex-direction: column; align-items: flex-start;"><span class="kpi-title">Utenti Totali</span><span class="kpi-value" id="adm-total">0</span></div>
                <div class="kpi-container" style="flex-direction: column; align-items: flex-start; border-color: var(--warning);"><span class="kpi-title">Abbonati PRO</span><span class="kpi-value" id="adm-pro" style="color:var(--warning)">0</span></div>
                <div class="kpi-container" style="flex-direction: column; align-items: flex-start; border-color: var(--primary);"><span class="kpi-title">Pagamenti OK</span><span class="kpi-value" id="adm-paid">0</span></div>
                <div class="kpi-container" style="flex-direction: column; align-items: flex-start; border-color: var(--info);"><span class="kpi-title">Conversion Rate</span><span class="kpi-value" id="adm-rate" style="color:var(--info)">0%</span></div>
            </div>

            <div class="admin-nav">
                <button class="admin-tab-btn active" onclick="app.admin.switchTab('pro')">UTENTI PRO</button>
                <button class="admin-tab-btn" onclick="app.admin.switchTab('all')">TUTTI GLI UTENTI</button>
            </div>

            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>EMAIL</th>
                            <th>UID FIRESTORE</th>
                            <th>DATA REGISTRAZIONE</th>
                            <th>PIANO</th>
                            <th>STATO PAGAMENTO</th>
                        </tr>
                    </thead>
                    <tbody id="admin-list">
                        </tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="modal-login" class="modal-backdrop">
        <div class="modal-panel" style="text-align: center;">
            <h2 style="margin-bottom: 2rem;">Accedi a InvestPro</h2>
            <button class="btn btn-primary" style="width: 100%; justify-content: center; padding: 1rem;" onclick="app.auth.loginGoogle()">
                <i class="fa-brands fa-google"></i> CONTINUA CON GOOGLE
            </button>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2rem;">Accedendo accetti i termini di servizio e la policy 2025.</p>
            <button class="btn" style="margin-top: 1.5rem; width: 100%; justify-content: center;" onclick="app.ui.closeModal('modal-login')">ANNULLA</button>
        </div>
    </div>

    <div id="modal-deals" class="modal-backdrop">
        <div class="modal-panel">
            <h2 style="margin-bottom: 1.5rem;">I Tuoi Deal Salvati</h2>
            <div id="deals-list-container" style="max-height: 400px; overflow-y: auto;"></div>
            <button class="btn" style="width: 100%; margin-top: 1.5rem; justify-content: center;" onclick="app.ui.closeModal('modal-deals')">TORNA ALLA SUITE</button>
        </div>
    </div>

    <div id="modal-amortization" class="modal-backdrop">
        <div class="modal-panel" style="max-width: 800px;">
            <h2 style="margin-bottom: 1.5rem;">Piano di Ammortamento Dettagliato</h2>
            <div style="max-height: 50vh; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead style="position: sticky; top: 0; background: var(--bg-card);">
                        <tr style="text-align: right; border-bottom: 2px solid var(--border); color: var(--text-muted);">
                            <th style="text-align: left; padding: 12px;">ANNO</th>
                            <th>QUOTA INTERESSI</th>
                            <th>QUOTA CAPITALE</th>
                            <th>DEBITO RESIDUO</th>
                        </tr>
                    </thead>
                    <tbody id="amort-table-body"></tbody>
                </table>
            </div>
            <button class="btn" style="width: 100%; margin-top: 1.5rem; justify-content: center;" onclick="app.ui.closeModal('modal-amortization')">CHIUDI</button>
        </div>
    </div>

    <script>
        /* --- CORE LOGIC INVESTPRO --- */
        
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyDiGDvR2yXm0DE7vlJNGrIPQB0G-ntLHc0",
                authDomain: "analisimmobiliare-3b4a7.firebaseapp.com",
                projectId: "analisimmobiliare-3b4a7",
                storageBucket: "analisimmobiliare-3b4a7.firebasestorage.app",
                messagingSenderId: "29979040948",
                appId: "1:29979040948:web:597ea331e06567d8d50be1"
            },
            stripe: "https://buy.stripe.com/test_4gM8wP85i5I0flc0PygjC01"
        };

        const state = { 
            user: null, 
            isPro: false, 
            isAdmin: false, 
            currentDocId: null, 
            chart: null,
            allUsersCache: [] 
        };

        const app = {
            init: () => {
                if (!firebase.apps.length) firebase.initializeApp(CONFIG.firebase);
                app.services.auth = firebase.auth();
                app.services.db = firebase.firestore();
                
                app.auth.init();
                app.chart.init();
                app.calc.update();

                // Listeners
                document.querySelectorAll('input[type="number"]').forEach(i => i.addEventListener('input', app.calc.update));
                document.getElementById('geo-search').addEventListener('input', (e) => app.geo.debounceSearch(e.target.value));
                window.onclick = (e) => { if(!e.target.closest('#geo-search')) app.ui.toggleElement('geo-results', false); };
            },

            services: { auth: null, db: null },

            ui: {
                setLoading: (s) => document.getElementById('loading-overlay').classList.toggle('active', s),
                toggleElement: (id, s) => document.getElementById(id).classList.toggle('hidden', !s),
                openModal: (id) => document.getElementById(id).classList.add('active'),
                closeModal: (id) => document.getElementById(id).classList.remove('active'),
                toast: (msg, type = 'info') => {
                    const t = document.createElement('div');
                    t.style.cssText = `background:var(--bg-card); color:white; padding:1.2rem; border-left:5px solid ${type==='error'?'var(--danger)':'var(--primary)'}; border-radius:8px; box-shadow:var(--shadow); font-weight:600; min-width:250px;`;
                    t.textContent = msg;
                    document.getElementById('toast-container').appendChild(t);
                    setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 500); }, 3500);
                },
                updateUIForUser: (u) => {
                    app.ui.toggleElement('auth-guest', !u);
                    app.ui.toggleElement('auth-user', !!u);
                    if(u) document.getElementById('user-email-display').textContent = u.email;
                },
                setProStatus: (pro) => {
                    state.isPro = pro;
                    document.getElementById('card-pro').classList.toggle('is-unlocked', pro);
                    const b = document.getElementById('badge-plan');
                    b.textContent = pro ? "INVESTPRO" : "GUEST";
                    b.style.background = pro ? "var(--warning)" : "var(--border)";
                    b.style.color = pro ? "#000" : "var(--text-muted)";
                }
            },

            auth: {
                init: () => {
                    app.services.auth.onAuthStateChanged(async (u) => {
                        state.user = u;
                        app.ui.updateUIForUser(u);
                        app.ui.closeModal('modal-login');
                        
                        if(u) {
                            const doc = await app.services.db.collection('users').doc(u.uid).get();
                            const data = doc.data() || {};
                            
                            state.isAdmin = data.role === 'admin';
                            app.ui.setProStatus(data.plan === 'pro');
                            
                            // Gestione visibilità Admin Panel
                            document.getElementById('admin-panel').style.display = state.isAdmin ? 'block' : 'none';
                            if(state.isAdmin) app.admin.refresh();

                            if(!doc.exists) {
                                await app.services.db.collection('users').doc(u.uid).set({
                                    email: u.email, plan: 'free', role: 'user', joined: new Date()
                                });
                            }
                        }
                    });
                },
                loginGoogle: () => app.services.auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()),
                logout: () => app.services.auth.signOut().then(() => location.reload())
            },

            geo: {
                debounceSearch: (q) => {
                    clearTimeout(app.geo.timer);
                    app.geo.timer = setTimeout(() => app.geo.fetch(q), 600);
                },
                timer: null,
                fetch: async (q) => {
                    if(q.length < 3) return;
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=it&limit=5`);
                    const data = await res.json();
                    const box = document.getElementById('geo-results');
                    box.innerHTML = '';
                    app.ui.toggleElement('geo-results', true);
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'dropdown-item';
                        div.textContent = item.display_name;
                        div.onclick = () => {
                            document.getElementById('geo-search').value = item.display_name;
                            app.ui.toggleElement('geo-results', false);
                            app.calc.update();
                        };
                        box.appendChild(div);
                    });
                }
            },

            calc: {
                val: (id) => parseFloat(document.getElementById(id).value) || 0,
                fmt: (n) => n.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' }),
                update: () => {
                    const adr = app.calc.val('adr'), occ = app.calc.val('occ')/100;
                    const ota = app.calc.val('portal-comm')/100, tax = app.calc.val('tax-rate')/100;
                    const varC = app.calc.val('var-costs'), fixC = app.calc.val('fixed-costs');

                    const rev = adr * 365 * occ;
                    const otaCost = rev * ota;
                    const taxCost = rev * tax;
                    const opCost = (varC * 365 * occ) + (fixC * 12);
                    const molAnnual = rev - otaCost - taxCost - opCost;

                    document.getElementById('res-mol-month').textContent = app.calc.fmt(molAnnual / 12);

                    if(state.chart) {
                        state.chart.data.datasets[0].data = [molAnnual > 0 ? molAnnual : 0, otaCost, taxCost, opCost];
                        state.chart.update();
                    }

                    // PRO SECTION
                    const price = app.calc.val('price');
                    const loan = price * (app.calc.val('ltv')/100);
                    const i = (app.calc.val('rate')/100)/12, n = app.calc.val('years')*12;
                    const m = (i > 0) ? loan * (i * Math.pow(1+i,n)) / (Math.pow(1+i,n)-1) : (n > 0 ? loan/n : 0);

                    document.getElementById('res-mortgage').textContent = app.calc.fmt(m);
                    document.getElementById('res-cashflow').textContent = app.calc.fmt((molAnnual/12) - m);
                },
                showAmortization: () => {
                    const loan = app.calc.val('price') * (app.calc.val('ltv')/100);
                    const i = (app.calc.val('rate')/100)/12, n = app.calc.val('years')*12;
                    if(loan <= 0 || n <= 0) return;
                    
                    let bal = loan, html = '', yInt = 0, yPri = 0;
                    const mPay = loan * (i * Math.pow(1+i,n)) / (Math.pow(1+i,n)-1);

                    for(let m = 1; m <= n; m++) {
                        let iPart = bal * i, pPart = mPay - iPart;
                        bal -= pPart; yInt += iPart; yPri += pPart;
                        if(m % 12 === 0) {
                            html += `<tr style="text-align:right; border-bottom:1px solid #334155;">
                                <td style="text-align:left; padding:12px; color:var(--primary); font-weight:700;">Anno ${m/12}</td>
                                <td>${app.calc.fmt(yInt)}</td><td>${app.calc.fmt(yPri)}</td><td>${app.calc.fmt(bal > 0 ? bal : 0)}</td>
                            </tr>`;
                            yInt = 0; yPri = 0;
                        }
                    }
                    document.getElementById('amort-table-body').innerHTML = html;
                    app.ui.openModal('modal-amortization');
                }
            },

            admin: {
                refresh: async () => {
                    if(!state.isAdmin) return;
                    app.ui.setLoading(true);
                    try {
                        const snap = await app.services.db.collection('users').get();
                        state.allUsersCache = [];
                        let proCount = 0, paidCount = 0;

                        snap.forEach(doc => {
                            const d = doc.data();
                            const userObj = { id: doc.id, ...d };
                            state.allUsersCache.push(userObj);
                            if(d.plan === 'pro') proCount++;
                            if(d.paymentStatus === 'success') paidCount++;
                        });

                        document.getElementById('adm-total').textContent = state.allUsersCache.length;
                        document.getElementById('adm-pro').textContent = proCount;
                        document.getElementById('adm-paid').textContent = paidCount;
                        document.getElementById('adm-rate').textContent = Math.round((proCount/state.allUsersCache.length)*100) + '%';
                        
                        app.admin.render('pro');
                        app.ui.toast("Dati Amministratore Aggiornati", "success");
                    } catch(e) { app.ui.toast("Errore sync admin: " + e.message, "error"); }
                    finally { app.ui.setLoading(false); }
                },

                render: (filter) => {
                    const tbody = document.getElementById('admin-list');
                    const filtered = filter === 'pro' ? state.allUsersCache.filter(u => u.plan === 'pro') : state.allUsersCache;
                    
                    tbody.innerHTML = filtered.map(u => `
                        <tr>
                            <td style="font-weight:700;">${u.email}</td>
                            <td style="font-family:monospace; font-size:0.75rem; color:var(--text-muted);">${u.id}</td>
                            <td>${u.joined ? (u.joined.toDate ? u.joined.toDate().toLocaleDateString() : 'N/D') : 'N/D'}</td>
                            <td><span class="status-pill ${u.plan==='pro'?'status-success':''}">${u.plan.toUpperCase()}</span></td>
                            <td><span class="status-pill ${u.paymentStatus==='success'?'status-success':'status-pending'}">${u.paymentStatus || 'IN ATTESA'}</span></td>
                        </tr>
                    `).join('');
                },

                switchTab: (tab) => {
                    document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
                    event.target.classList.add('active');
                    app.admin.render(tab);
                }
            },

            data: {
                saveProject: async () => {
                    if(!state.user) return app.ui.openModal('modal-login');
                    app.ui.setLoading(true);
                    const inputs = {};
                    document.querySelectorAll('input').forEach(i => inputs[i.id] = i.value);
                    const payload = { uid: state.user.uid, name: document.getElementById('project-name').value, updatedAt: new Date(), inputs };
                    
                    try {
                        if(state.currentDocId) await app.services.db.collection('projects').doc(state.currentDocId).update(payload);
                        else state.currentDocId = (await app.services.db.collection('projects').add(payload)).id;
                        app.ui.toast("Deal salvato correttamente", "success");
                    } catch(e) { app.ui.toast("Errore salvataggio", "error"); }
                    finally { app.ui.setLoading(false); }
                },

                openDealsList: async () => {
                    if(!state.user) return app.ui.openModal('modal-login');
                    app.ui.openModal('modal-deals');
                    const snap = await app.services.db.collection('projects').where('uid','==',state.user.uid).get();
                    const cont = document.getElementById('deals-list-container');
                    cont.innerHTML = snap.empty ? '<p style="text-align:center; padding:2rem; color:var(--text-muted);">Nessun deal salvato.</p>' : '';
                    snap.forEach(doc => {
                        const d = doc.data();
                        const row = document.createElement('div');
                        row.style.cssText = "padding:1.2rem; border-bottom:1px solid var(--border); cursor:pointer; display:flex; justify-content:space-between; align-items:center;";
                        row.innerHTML = `<div><div style="font-weight:700;">${d.name}</div><div style="font-size:0.7rem; color:var(--text-muted);">${d.updatedAt.toDate().toLocaleDateString()}</div></div><i class="fa-solid fa-chevron-right" style="color:var(--primary)"></i>`;
                        row.onclick = () => {
                            state.currentDocId = doc.id;
                            Object.keys(d.inputs).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = d.inputs[k]; });
                            app.calc.update(); app.ui.closeModal('modal-deals');
                        };
                        cont.appendChild(row);
                    });
                }
            },

            report: {
                generate: () => {
                    if(!state.isPro) return app.ui.toast("Report PDF disponibile solo per InvestPro.", "error");
                    const doc = new jspdf.jsPDF();
                    doc.setFontSize(22); doc.setTextColor(16, 185, 129);
                    doc.text("INVESTPRO DEAL REPORT", 15, 20);
                    doc.setFontSize(10); doc.setTextColor(100);
                    doc.text("Analisi professionale generata il " + new Date().toLocaleString(), 15, 28);
                    
                    doc.autoTable({
                        startY: 40,
                        head: [['Parametro Analizzato', 'Valore']],
                        body: [
                            ['Progetto', document.getElementById('project-name').value],
                            ['MOL Mensile', document.getElementById('res-mol-month').textContent],
                            ['Rata Mutuo', document.getElementById('res-mortgage').textContent],
                            ['Cash Flow Netto', document.getElementById('res-cashflow').textContent]
                        ],
                        headStyles: { fillColor: [16, 185, 129] }
                    });
                    doc.save("InvestPro_Report.pdf");
                }
            },

            chart: {
                init: () => {
                    const ctx = document.getElementById('profitChart').getContext('2d');
                    state.chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Utile Netto', 'OTA', 'Tasse', 'Costi Op.'],
                            datasets: [{ data: [0,0,0,0], backgroundColor: ['#10b981','#f59e0b','#ef4444','#3b82f6'], borderWidth: 0, hoverOffset: 10 }]
                        },
                        options: { maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, color: '#94a3b8', font: { size: 10 } } } } }
                    });
                }
            },

            payment: {
                start: () => {
                    if(!state.user) return app.ui.openModal('modal-login');
                    window.open(CONFIG.stripe + "?client_reference_id=" + state.user.uid, "_blank");
                }
            }
        };

        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
